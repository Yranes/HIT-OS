## 1.x86系统架构概览

### 1.1 系统级体系结构概览

#### 概览图

![2-1p](./images/Figure%202-1.png "Figure 2-1")

#### 全局和局部描述符表

全局描述符表(Global Descriptor Table, GDT)和局部描述符表(Local Descriptor Table, LDT)是基于x86架构的操作系统中用于实现分段内存管理机制的数据结构。

GDT是一个位于内存中的表格，包含多个段描述符（Segment Descriptor），每个描述符用于描述一段连续的内存，包括其基地址、段长度、访问权限等信息。GDT是全局共享的，因此在系统中只有一个GDT。

LDT和GDT的结构类似，它也是一张用于存储段描述符的表。不同的是，每个进程都可以有自己的LDT，而这个LDT中的描述符是相对于GDT的描述符进行解释的。因此，LDT中的描述符只有在进程切换时才会被加载进处理器中。

在保护模式下，访问地址需要由段基址和偏移量相加得到。通过段选择器我们得到段基址，再根据偏移值即可得到想要访问的数据的地址。

通过使用GDT和LDT，操作系统可以实现对每个进程所能访问的内存区域的限制，从而保障系统的安全性和稳定性。同时，GDT和LDT也为操作系统提供了管理内存映射、调度进程等功能的基础。

#### 系统段， 段描述符， 门

系统中定义了两种系统段结构，分别为任务状态段和局部描述符表，二者均有对应的段描述符。而GDT并不是一个段结构，因为它并不能用段描述符和段选择器访问。

段描述符是一个数据结构，用于描述一个段的大小、属性和基地址等信息，存在于段描述符表（GDT）或者局部描述符表（LDT）之中。它由 16 个字节组成，包括段基址、段界限、访问标志和控制标志等信息。

系统结构中同样定义了一种特殊的描述符，叫门。他提供了一种受保护的方式去调用跨特权的系统调用或者处理。当权限较低的代码段需要访问更高权限的代码段时，可以通过调用门的方式，获取到目标代码段的段描述符，有时也需要更改权限为目标代码段的所在权限。从而实现访问。

#### 任务状态段和任务门

任务状态段（Task State Segment，TSS）是一个数据结构，其中包含有关任务状态的信息，例如处理器寄存器值和堆栈指针。每个任务都有一个唯一的TSS，当任务从当前执行的任务切换时，处理器将当前任务的状态保存到其TSS中，然后加载下一个任务的TSS并将其状态还原。

任务门（Task Gate）是一个描述性数据结构，用于将控制转移到新的任务。任务门包含有关要切换到的任务的信息，例如其TSS选择器和执行地址。当处理器执行任务门指令时，它会保存当前任务的状态并加载新任务的TSS。

#### 中断和异常处理

外部中断，软件中断和异常是通过中断描述符表（IDT）处理的，IDT存储了一系列的门描述符，它们可以访问中断和异常处理程序。中断描述符表的线性基址存储在IDT寄存器中（IDTR）。

在IDT中的门描述符可以是中断，陷阱，或者任务门描述符。我们首先接收到内部硬件发送的中断信号或者外部的中断指令信号，中断向量会指向IDT的一个中断描述符，并跳转到中断处理程序。

#### 内存管理

系统支持直接物理寻址或者虚拟内存寻址，当使用分页时，所有代码，数据，栈，段都可以分页，但是只有最近访问的页会存在物理内存中。页在物理内存中的位置存储在分页结构中，而分页结构的物理基址存储在控制寄存器CR3中，分页结构中的条目决定了页的物理基址，访问权限等信息。

#### 系统寄存器

为了帮助初始化处理器和控制系统操作，系统结构提供了一些标志系统寄存器：

- EFLAGS寄存器，控制着任务和模式选择，中断处理，指令跟踪和访问权限。
- 控制寄存器（CR0,CR1,CR2,CR4），包含一系列标志和数据用于控制系统级操作。
- 调试寄存器，允许设置断点，用于程序，软件调试。
- GDTR，LDTR，IDTR，储存各个表的线性地址和大小（限制）。
- 任务寄存器，存储当前任务的在TSS中的线性地址。

### 1.2 实模式和保护模式转换

#### 实模式和保护模式

- 保护模式：处理器的基本操作模式，提供了丰富的架构特性，灵活，高性能，与现有软件库的优秀向后兼容性。
- 实地址模式：提供编程环境，并拥有一些扩展特性（例如可以跳转到保护模式和SMM模式）

#### 各模式跳转示意图

![](./images/Figure%202-3.png)

#### 实模式跳转到保护模式

- 关中断
- 打开地址线A20
- 置cr0寄存器的末位为1 (PE = 1)
- 实现跳转，进入到保护模式

#### 保护模式跳转到实模式

- 从保护模式下的32位代码段跳转到16位代码段
- 在16位代码段下初始化所有段寄存器
- 置cr0的末位为0 (PE = 0)
- 实现跳转，返回到实模式

### 1.3 80x86系统指令寄存器

#### EFLAGS标志寄存器

可以用于控制I/O，（可mask的）硬件中断，调试，任务选择和虚模式。

- TF（bit 8）置1允许单步调试模式，置0则不允许。
- IF（bit 9）置1响应可屏蔽中断，置0则不响应。
- IOPL（bit 12 and 13）指示当前任务的I/O特权级，正在运行任务的当前特权级(CPL)必须小于或等于I/O特权级才能允许访问I/O地址空间。
- NT（bit 14）正在运行任务的当前特权级(CPL)必须小于或等于I/O特权级才能允许访问I/O地址空间。
- RF（bit 16）控制处理器对调试异常的响应。
- VM（bit 17）置1以允许虚拟8086模式，清除则返回保护模式。
- C（bit 18）该标志以及在CR0寄存器中的AM位置1时将允许内存引用的对齐检查，以上两个标志中至少有一个被清零则禁用对齐检查。
- VIF（bit 19）该标志是IF标志的虚拟镜像(Virtual image)，与VIP标志结合起来使用。使用这个标志以及VIP标志，并设置CR4控制寄存器中的VME标志就可以允许虚拟模式扩展。
- VIP（bit 20）该位置1以指示一个中断正在被挂起，当没有中断挂起时该位清零。与VIF标志结合使用。
- ID（bit 21）程序能够设置或清除这个标志指示了处理器对CPUID指令的支持。

#### 内存控制寄存器
处理器提供了4个内存管理寄存器（GDTR、LDTR、IDTR和TR），用于指定分段内存管理所使用的系统表的基地址。处理器为这些寄存器加载和保存提供了特定的指令。

- GDTR，存放全局描述符表GDT的32位线性基地址和16位表长度值。指令LGDT和SGDT用于加载和保存GDTR寄存器的内容。
- LDTR，用于存放局部描述符LDT的32位线性基地址、16位段限长和描述符属性值。LLDT和SLDT分别用于加载和保存LDTR寄存器的段描述符部分。
- IDTR，用于存放中断描述符表IDT的32位线性基地址和16位表长度值，指令LIDT和SIDT分别用于加载和保存IDTR寄存器的内容。
- TR，用于存放当前任务TSS段的16位段选择符、32位基地址、16位段长度和描述符属性值。它引用GDT表中一个TSS类型的描述符。指令LTR和STR分别用于加载和保存TR寄存器的段选择符部分。当执行任务切换时，处理器会把新任务TSS的段选择符和段描述符自动加载到TR寄存器中。
  
#### 控制寄存器

- CR0，含有控制处理器操作模式和状态的系统控制标志。
- CR1，是未定义的控制寄存器，供将来的处理器使用。
- CR2，是页故障线性地址寄存器，保存最后一次出现页故障的全32位线性地址。
- CR3，是页目录基址寄存器，保存页目录表的物理地址，页目录表总是放在以4K字节为单位的存储器边界上，因此，它的地址的低12位总为0，不起作用，即使写上内容，也不会被理会。
- CR4，在Pentium系列（包括486的后期版本）处理器中才实现，它处理的事务包括诸如何时启用虚拟8086模式等。

### 1.4 系统指令

- LGDT，将GDT的基地址和表长界限从内存中载入GDTR中。
- SGDT，将GDTR中的基地址和表长界限存入内存中。
- LIDT，将IDT的基地址和表长界限从内存中载入IDTR中。
- SIDT，将IDTR中的基地址和表长界限存入内存中。
- LLDT，将LDT的段选择器和段描述符从内存中载入LDTR中。
- SLDT，将LDTR中的段选择器存入通用寄存器或内存中。
- LTR，将段选择器和TSS段描述符载入TR中。
- STR，将当前任务的TSS段选择子存入内存中或通用寄存器中。